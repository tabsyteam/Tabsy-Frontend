<!DOCTYPE html>
<html>
<head>
    <title>Session Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .section { margin: 20px 0; padding: 15px; background: #2d2d2d; border-radius: 8px; }
        .key { color: #9cdcfe; }
        .value { color: #ce9178; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #1e1e1e; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Session Storage Debug Tool</h1>

    <div class="section">
        <h2>Quick Actions</h2>
        <button onclick="checkSession()">Check Session</button>
        <button onclick="clearAll()">Clear All Storage</button>
        <button onclick="location.reload()">Refresh Page</button>
    </div>

    <div class="section">
        <h2>Session Storage Contents</h2>
        <div id="storage"></div>
    </div>

    <div class="section">
        <h2>Test URLs</h2>
        <button onclick="testQR()">Test QR Flow</button>
        <button onclick="testDirect()">Test Direct URL</button>
        <button onclick="testTable()">Test /table</button>
    </div>

    <div id="output" class="section" style="display:none;">
        <h2>Analysis</h2>
        <pre id="analysis"></pre>
    </div>

    <script>
        function checkSession() {
            const storage = document.getElementById('storage');
            const output = document.getElementById('output');
            const analysis = document.getElementById('analysis');

            let html = '<pre>';
            let analysisText = '';

            // Check all sessionStorage keys
            const keys = Object.keys(sessionStorage);

            if (keys.length === 0) {
                html += '‚ùå No session storage data found\n\n';
                analysisText = '‚ùå PROBLEM: No session exists\n\nSOLUTION: You need to scan QR code first:\nhttp://localhost:3002/table/QR_TABLE_2_TEST?r=test-restaurant-id&t=table-2';
            } else {
                html += `‚úÖ Found ${keys.length} entries:\n\n`;

                keys.forEach(key => {
                    const value = sessionStorage.getItem(key);
                    html += `<span class="key">${key}</span>:\n`;

                    try {
                        const parsed = JSON.parse(value);
                        html += `<span class="value">${JSON.stringify(parsed, null, 2)}</span>\n\n`;
                    } catch {
                        html += `<span class="value">${value}</span>\n\n`;
                    }
                });

                // Analyze
                const hasUnified = sessionStorage.getItem('tabsy-session');
                const hasQR = sessionStorage.getItem('tabsy-qr-access');
                const hasTableInfo = sessionStorage.getItem('tabsy-table-info');

                if (hasUnified && hasQR) {
                    analysisText = '‚úÖ SESSION HEALTHY\n\n';
                    analysisText += 'Unified session: Present\n';
                    analysisText += 'QR cache: Present\n';
                    analysisText += 'Table info: ' + (hasTableInfo ? 'Present' : 'Missing') + '\n\n';
                    analysisText += 'Page refresh should work!';
                } else if (hasUnified && !hasQR) {
                    analysisText = '‚ö†Ô∏è  PARTIAL SESSION\n\n';
                    analysisText += 'Session exists but QR cache missing.\n';
                    analysisText += 'Refresh might fail on /r/{restaurant}/t/{table}\n\n';
                    analysisText += 'SOLUTION: Navigate to /table instead';
                } else if (!hasUnified) {
                    analysisText = '‚ùå NO VALID SESSION\n\n';
                    analysisText += 'SOLUTION: Scan QR code first';
                }
            }

            html += '</pre>';
            storage.innerHTML = html;
            analysis.textContent = analysisText;
            output.style.display = 'block';
        }

        function clearAll() {
            if (confirm('Clear all session storage?')) {
                sessionStorage.clear();
                alert('‚úÖ Cleared! Now scan QR code.');
                checkSession();
            }
        }

        function testQR() {
            window.location.href = 'http://localhost:3002/table/QR_TABLE_2_TEST?r=test-restaurant-id&t=table-2';
        }

        function testDirect() {
            window.location.href = 'http://localhost:3002/r/test-restaurant-id/t/table-2?qr=QR_TABLE_2_TEST';
        }

        function testTable() {
            window.location.href = 'http://localhost:3002/table';
        }

        // Auto-check on load
        checkSession();
    </script>
</body>
</html>
